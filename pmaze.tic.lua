--
-- vim: set shiftwidth=2 tabstop=2 expandtab:
--
-- title:  pillarmaze
-- author: lzap
-- desc:   inspired by a minigame from funcade
-- script: lua
--

total=3600.0 -- total game time until game over
mn=1 -- current level number
mx=0 -- current map x cell
my=0 -- current map y cell
hx=-1 -- head position x
hy=-1 -- head position y
tb=-1 -- blink border until time
hint=nil -- hud hint text
hintStarted=-1 -- hint message time

function BOOT()
  --trace("BOOT")
end

-- find map tile flag ignoring the first row
function flagAt(x, y, flag)
  local id = mget(x * 2, 1 + y * 2)
  return fget(id, flag), id
end

-- find starting head position via sprite flags
function spritePos(flag)
  for x = mx//2, mx//2 + 15 do
    for y = my//2, my//2 + 8 do
      local flag, id = flagAt(x, y, flag)
      if flag then
        trace("found flag at x="..x.." y="..y.." mx="..mx.." my="..my.." id="..id)
        return x, y
      end
    end
  end
  trace("sprite not found!")
  exit()
end

-- when floor is all clear
function levelDone()
  for x = mx//2, mx//2 + 15 do
    for y = my//2, my//2  +8 do
      local flag = flagAt(x, y, 2)
      if flag then return false end
    end
  end
  return true
end

function startHint(ms,msg)
  hint=msg
  hintStarted = time()+ms
end

function moveh(dx,dy)
  nx=hx-dx
  ny=hy-dy
  -- wall hit
  if flagAt(nx, ny, 7) then
    startHint(2000, "(B) to restart")
  else
    mset(0 + hx * 2, 1 + 0 + hy * 2, 4)
    mset(0 + hx * 2, 1 + 1 + hy * 2, 20)
    mset(1 + hx * 2, 1 + 0 + hy * 2, 5)
    mset(1 + hx * 2, 1 + 1 + hy * 2, 21)
    hx=nx
    hy=ny
    mset(0 + hx * 2, 1 + 0 + hy * 2, 4)
    mset(0 + hx * 2, 1 + 1 + hy * 2, 20)
    mset(1 + hx * 2, 1 + 0 + hy * 2, 5)
    mset(1 + hx * 2, 1 + 1 + hy * 2, 21)
  end
  trace("head at hx="..nx.." hy="..ny.." x="..(hx % 15 * 16).." y="..(hy % 8 * 16))
  trace("level done: "..tostring(levelDone()))
end

function resetLevel()
  trace("Level reset")
  hx=-1
  hy=-1
  hint=nil
  hintStarted=-1
  -- throw away all map changes
  sync(0, 0, false)
end

function nextLevel()
  mn=mn+1
  mx=mx+30
  resetLevel()
  -- TODO: save last level with pmem
end

function hintTIC()
  local tm=time()
  if tm > hintStarted then
    hintStarted=-1
  else
    d=string.len(hint)*8
    print(hint,(240-d)//2,0,(tm%3)+2)
  end
end

function hudTIC()
  local tm=string.format("%.1f",total-time()/1000)
  print("Level "..mn,0,0,12)
  print("Time "..tm,240-8*7,0,12)
end

function TIC()
  cls(0)
  map(mx, my)
  if hx == -1 then
    hx, hy = spritePos(0)
  end
  if hx == nil or hy == nil then
    trace("Starting position not found")
    exit()
  end
  if btnp(0,60,6) then moveh(0,1) end
  if btnp(1,60,6) then moveh(0,-1) end
  if btnp(2,60,6) then moveh(1,0) end
  if btnp(3,60,6) then moveh(-1,0) end
  if btnp(5,60,6) then resetLevel() end
  -- draw head
  spr(256, hx % 15 * 16, (hy % 8 * 16) + 8, -1, 1, 0, 0, 2, 2)
  -- level done
  --if flagAt(hx,hy,1) then
  if levelDone() then
    nextLevel()
  end
  hudTIC()
  hintTIC()
end

-- <TILES>
-- 002:0000000001111111011111110111111101111111011111110111111101111111
-- 003:0000000011111110111111101111111011111110111111101111111011111110
-- 004:0000000000000000000444440043344400433444004443340044433400444443
-- 005:0000000000000000444440004443340044433400433444004334440034444400
-- 006:000000000eeeeeee0eeeeeee0eeeeeee0eeeeeee0eeeeeee0eeeeeee0eeeeeee
-- 007:00000000eeeeeee0eeeeeee0eeeeeee0eeeeeee0eeeeeee0eeeeeee0eeeeeee0
-- 018:0111111101111111011111110111111101111111011111110111111100000000
-- 019:1111111011111110111111101111111011111110111111101111111000000000
-- 020:0044444300444334004443340043344400433444000444440000000000000000
-- 021:3444440043344400433444004443340044433400444440000000000000000000
-- 022:0eeeeeee0eeeeeee0eeeeeee0eeeeeee0eeeeeee0eeeeeee0eeeeeee00000000
-- 023:eeeeeee0eeeeeee0eeeeeee0eeeeeee0eeeeeee0eeeeeee0eeeeeee000000000
-- 032:0000000000000000000000000000000000009999000099990000999200009992
-- 033:0000000000000000000000000000000099990000999900002999000029990000
-- 034:0000000000000000000000000000000000009999000099990000990000009900
-- 035:000000000000000000000000000000009999000099990000cc990000cc990000
-- 048:0000999600009996000099990000999900000000000000000000000000000000
-- 049:6999000069990000999900009999000000000000000000000000000000000000
-- 050:000099cc000099cc000099990000999900000000000000000000000000000000
-- 051:0099000000990000999900009999000000000000000000000000000000000000
-- 240:000000000000000000000000000cc000000cccc00000c0c00000ccc000000000
-- </TILES>

-- <SPRITES>
-- 000:0000000000444444044444440444444404444444044499440444994404444444
-- 001:0000000044444400444444404444444044444440449944404499444044444440
-- 016:0444444304444443044333330444333304444444044444440044444400000000
-- 017:3444444034444440333334403333444044444440444444404444440000000000
-- </SPRITES>

-- <MAP>
-- 000:000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001000100010001000100010001000100010001000100010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 001:001010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000011101110111011101110111011101110111011101110111000000000000000000000000000000000000000000000000000000000000000000000000000000000020302030203020302030000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 002:011111000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001110000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000021312131213121312131000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 003:000000000000000000011100000000000000000000000000000000000000000000000000000000000000000000000000000020300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000020306070607060702030000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 004:000000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000021310000000000000000000000002020202020202020202020202020202020202020202000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000021316171617161712131000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000011100000000000000000000000000000000000000
-- 005:000000000111203020302030203020302030203020302030000000000000000000000000203020302030001000100000203020302030000000000000000000002030203020302030203020302030203020302030203000000000000000000000000000100010203020302030203020300000000000000000000000000000203020302030203020302030203020300000000000000000000000000000000020306070203002122030203020300000000000000000000000000000000000000000000000000000000000000000000000000000000000000010203020302030203020302030203020302030000000000000
-- 006:000000000000213121312131213121312131213121312131001000100010000000000000213121312131011101110101213121312131000000000000000000002131213121312131213121312131213121312131213100000000000000000000000001110111213121312131213121310000000000000000000000000000213121312131213121312131213121312000000000000000000000000000000021316171213103132131213121310000000000000000000000000000000000000000000000000000000000000000000000000000000000000011213121312131213121312131213121312131000000000000
-- 007:000000000000203002126070607060706070607060702030011101110111000000000000203002122030203020300010203060702030203000000000000000002030607060706070021220306070607060706070203000000000000000000000000000002030203060706070203020300000000000000000000000000000203060706070607060706070607020302030000000000000000000000000000020306070607060706070607020300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000203002126070607060706070607060702030000000000000
-- 008:000000000000213103136171617161716171617161712131001000100010000000000000213103132131213121310111213161712131213100000000000000002131617161716171031321316171617161716171213100000000000000000000000000002131213161716171213121310000000000000000000000000000213161716171617161716171617121312131000000000000000000000000000021316171617161716171617121310000000000000000000000000000000000000000000000000000000000000000000000000000000000000000213103136171617161716171617161712131010000000000
-- 009:000000000000203020302030203020302030203060702030011101110111000000000000203060706070607020302030203060702030203000000000000000002030607020302030203020302030203020306070203000000000000000000000000020302030607060706070203020300000000000000000000000000000203060700000607060700000607020302030000000000000000000000000000020302030203060702030607020300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000203022326070607060706070607060702030000000000000
-- 010:000000000010213121312131213121312131213161712131101000100010000000000000213161716171617121312131213161712131213100000000000000002131617121312131213121312131213121316171213100000000000000000000000021312131617161716171213121310000000000000000000000000000213161710000617161710000617121312131000000000000000000000000000021312131213161712131617121310000000000000000000000000000000000000000000000000000000000000000000000000000000000000000213123336171617161716171617161712131010000000000
-- 011:000000000111000000000000000000000000203060702030111101110111000000000000203020302030607060706070607060702030203000000000000000002030607060706070607060706070607060706070203000000000000000000000000020300212607060706070203020300000000000000000000000000000203060706070607060706070607002122030000000000000000000000000000000000000203060706070607020300000000000000000000000000000000000000000000000000000000000000000000000000000000000000010203020302030203020302030203020302030100000000000
-- 012:000000000000000000000000000000000000213161712131000000000000000000000000213121312131617161716171617161712131213100000000000000002131617161716171617161716171617161716171213100000000000000000000000021310313617161716171213121310000000000000000000000000000213161716171617161716171617103132131000000000000000000000000000000000000213161716171617121310000000000000000000000000000000000000000000000000000000000000000000000000000000000000011213121312131213121312131213121312131110000000000
-- 013:000000000000000000000000000000000000203020302030000000000000000000000000000000002030203020302030203020302030001000000000000000002030203020302030203020302030203020302030203000000000000000000000000020302030203020302030203020300000000000000000000000000000203020302030203020302030203020302030000000000000000000000000000000000000203020302030203020300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000100010001010000000000000
-- 014:000000000000000000000000000000000000213121312131000000000000000000000000000000002131213121312131213121312131001100000000000000002131213121312131213121312131213121312131213100000000000000000000000021312131213121312131213121310000000000000000000000000000213121312131213121312131213121312131000000000000000000000000000000000000213121312131213121310000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- </MAP>

-- <WAVES>
-- 000:00000000ffffffff00000000ffffffff
-- 001:0123456789abcdeffedcba9876543210
-- 002:0123456789abcdef0123456789abcdef
-- </WAVES>

-- <SFX>
-- 000:00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000030b000000000
-- </SFX>

-- <FLAGS>
-- 000:00000808080840400000000000000000000008080808404000000000000000001010202000000000000000000000000010102020000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- </FLAGS>

-- <PALETTE>
-- 000:1a1c2c5d275db13e53ef7d57ffcd75a7f07038b76425717929366f3b5dc941a6f673eff7f4f4f494b0c2566c86333c57
-- </PALETTE>

